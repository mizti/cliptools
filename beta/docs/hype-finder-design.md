# 新ツール: hype-finder の設計

## 1. 本ツールの目的

本ツールは、指定された YouTube（以下 YT）動画の**ライブチャットリプレイ**を取得・解析し、
「配信が盛り上がっていた（と推測される）時間帯」を自動で検出・可視化することを目的とする。

本ツールは当面 `beta/` ディレクトリ配下で開発を行うが、
コード中のモジュール名やクラス名・関数名には `beta` などの接頭辞を付けず、
将来的にディレクトリ構成を変更してもそのまま移動しやすい形を保つ。
既存の `download.sh` などとは**直接の依存関係を持たない**（読み取り参照は可）。
将来的には cliptools 全体のワークフローに組み込めるような設計を意識しつつ、
まずは単体ツールとして完成させる。

---

## 2. 想定ユースケース

- クリッパーが「どこが盛り上がっていたか」をざっくり把握したいときに、
	hype-finder が提案する**盛り上がり区間の SRT**を開いて眺める。
- Premiere Pro などの編集ツールに SRT をインポートし、
	タイムライン上で**盛り上がり候補区間を視覚的に確認**する。
- 同時に出力される**コメント密度ヒートマップ（PNG 画像）**を見て、
	手動で「ここから少し前後を掘るか」を判断する。

---

## 3. 入力と出力

### 3-1. 入力

必須入力:

- 対象となる YT 動画の URL または動画 ID

前提・制約:

- **ライブチャットリプレイが取得できる動画のみを対象**とする。
	- ライブチャットリプレイが無効 / 存在しない動画については、
		エラーにはせず「何も出力しない」（あるいは軽いログのみ）挙動とする。

任意入力:

- 出力ディレクトリ（`-o` オプション）
	- `cliptools` の他ツールと同様、`clips/...` 配下を指定する想定
- 絵文字・特定文字のカスタム定義ファイル
	- 一般的な絵文字以外に、**チャンネル固有の絵文字**や特定のリアクション単語を
		追加で指定できるようにする（例: `settings/hype-finder-emoji.txt` など配置先は任意）。

### 3-2. 出力

本ツールのコア出力は次の 2 つとする。

1. **盛り上がり区間 SRT ファイル**
	 - 形式: 通常の SRT（`index` / `start --> end` / `テキスト`）
	 - 各ブロックは「盛り上がり区間」を表す。
	 - **テキスト部にはスコアのみを記載**する。
		 - 例: `HYPE SCORE: 0.87`
	 - 「盛り上がりのタイプ」などの細分類は行わず、
		 単一のスコアでシンプルに表現する。
	 - これにより、Premiere などにインポートした際にも
		 **タイムライン上で強度だけを直感的に把握できる**。

2. **コメント密度ヒートマップ画像（PNG）**
	 - 横軸: 動画の経過時間
	 - 縦軸: コメント数あるいはスコア（色の濃さで表現）
			 - 最低限として 1D の「時間 vs コメント密度（またはスコア）」を、
				 **5 秒単位**のビンで集計してヒートマップ風に描画した PNG を出力する。

出力ディレクトリ構成:

- `-o OUTDIR` を指定した場合、ファイルレイアウトは次のようにする:

	```text
	OUTDIR/
			hype_segments.srt        # 盛り上がり区間 SRT（成果物）
			hype_heatmap.png        # コメント密度ヒートマップ（成果物）
			hype-data/              # 中間生成物・解析用データ
					...                 # 必要に応じて JSON などを配置
	```

- 「人間が直接見る成果物」は `OUTDIR` 直下に置き、
	中間的なデータ（ビンごとのスコアや元コメントの一部キャッシュなど）は
	`OUTDIR/hype-data/` 以下にまとめる。

補足:

- ライブチャットリプレイを取得できなかった場合、
	上記いずれの出力ファイルも**作成しない**。

---

## 4. アーキテクチャ / 構成モジュール

本ツールは当面 `beta/` 配下で開発するが、論理的な構成はディレクトリ階層に依存しないものとし、主に以下の責務に分割する。

1. **コメント取得モジュール / シェルラッパー**
	 - 役割: YT 動画 URL / ID から yt-dlp を用いてライブチャット字幕 JSON を取得する。
	 - 実装方針（v1 固定仕様）:
		 - Python 本体からは直接 yt-dlp を呼ばず、外側に配置するシェルスクリプト（例: `hype-finder.sh`）が yt-dlp を叩く。
			 - コマンド例:
				 - `yt-dlp --skip-download --write-subs --sub-format live_chat --sub-lang live_chat -o "OUTDIR/hype-data/%(id)s" "https://www.youtube.com/watch?v=XXXXXXXXXXX"`
				 - これにより、`OUTDIR/hype-data/<video_id>.live_chat.json` という字幕トラック JSON が得られる。
		 - ライブチャットリプレイ非対応動画の場合は yt-dlp 側で字幕トラックが取得できないため、その場合は以降の解析ステップをスキップし、成果物 SRT/PNG を出さない。

2. **JSON → JSONL 前処理モジュール（Python）**
	 - 入力: yt-dlp が出力した `<video_id>.live_chat.json`
	 - 出力: `OUTDIR/hype-data/live_chat.jsonl`（もしくは `<video_id>.live_chat.jsonl`）
	 - 仕様:
		 - yt-dlp のライブチャット字幕は 1 ファイルに複数の JSON オブジェクトが連結された NDJSON 形式に近い構造を取るため、通常の `json.load` では扱わず、**1 行 1 オブジェクト**として順次 `json.loads` する。
		 - 各オブジェクトから `replayChatItemAction.actions[*].addChatItemAction.item.liveChatTextMessageRenderer` を持つ要素のみを対象とし、次の情報を抽出・正規化して 1 行の JSON に落とし込む:
			 - `timestamp_sec`: `replayChatItemAction.videoOffsetTimeMsec` を秒に変換したもの（動画相対秒）。利用不可の場合は `liveChatTextMessageRenderer.timestampUsec` から代替的に算出。
			 - `author`: `authorName.simpleText`。
			 - `message`: `message.runs` の `text` と `emoji.shortcuts`（無ければ `emojiId`）をフラットに連結した文字列。
		 - 出力フォーマットは **JSON Lines（NDJSON）** とし、1 行 1 コメントとする:
			 - 例: `{ "timestamp_sec": 12.34, "author": "@someone", "message": "LET'S GOOOO ❤🧡" }`
		 - スーパーチャットやメンバーシップイベントなど他種のレンダラー（`liveChatPaidMessageRenderer` / `liveChatMembershipItemRenderer` 等）は初期版では無視するか、必要であれば別ファイルに集計する（スコアには加味しない）。

3. **前処理・特徴量抽出モジュール（ビン集計）**
	 - 入力: JSONL 形式のコメント列（`timestamp_sec`, `author`, `message`）
	 - 出力: 時系列に整列した特徴量ベクトル系列（5 秒ビンなど）
	 - 仕様:
		 - JSONL ファイルを 1 行ずつストリーミング読み込みし、各行の `timestamp_sec` からビン index を計算して次の特徴量を蓄積する:
			 - コメント数（密度）
			 - 絵文字出現数
				 - 一般的な絵文字一覧
				 - カスタム絵文字辞書（ファイルで指定）
			 - 特定文字列（例: 草、w、lol など）の出現数
		 - ファイル全体をメモリに展開せず、**ビン配列のみをメモリ常駐させる**ことで、長時間配信・高頻度チャットにも対応しやすくする。
	 - スパチャは「盛り上がりとは必ずしも直結しない」という前提に基づき、
		 少なくとも初期バージョンではスコアには**加味しない**。

4. **盛り上がりスコアリング & ピーク検出モジュール**
	 - 入力: 時系列特徴量
	 - 出力: 各時間窓の「盛り上がり度スコア」および、ピーク区間のリスト
	 - ロジックの例:
		 - ベースライン: コメント密度に比例するスコア
		 - ボーナス項目:
			 - 絵文字（特にリアクション系）の数
			 - 感嘆符や「ｗ」などのリアクション文字の頻度
		 - スコアの時間方向平滑化（移動平均など）
		 - 一定閾値以上の連続区間を「盛り上がり区間」として抽出

5. **SRT 生成モジュール**
	 - 入力: 盛り上がり区間リスト + 各区間の要約情報
	 - 出力: 盛り上がり区間 SRT
	 - 仕様:
		 - 各区間は `start_time` ～ `end_time` を SRT のフォーマットに変換する。
		 - テキスト部にはスコア・コメント統計情報・代表コメントなどを**人間が読める形**で書く。

6. **ヒートマップ生成モジュール**
	 - 入力: 時系列スコア or コメント密度
	 - 出力: PNG 画像
	 - 仕様:
		 - 単純な棒グラフ or ラインチャートでもよいが、
			 一般的な「ヒートマップ」ライクな見た目を目指す。
		 - 依存ライブラリは Python 標準 + 軽量な描画ライブラリ（matplotlib 等）を想定。

---

## 5. 盛り上がり度の定義と指標

盛り上がり度（hype score）は完全な客観指標ではなく、
あくまで「クリッパーが候補を探す手がかり」として設計する。

### 5-1. 基本指標

- **コメント密度**: 単位時間あたりのコメント数
	- 最もシンプルかつ信頼できるベースライン指標。
- **特定文字 / 絵文字の出現数**:
	- 例: 草（w）、www、LOL、OMG などのリアクション文字列
	- 😆 😂 🤣 🔥 などの一般的な「沸き」絵文字
- **カスタム絵文字 / リアクション語**:
	- チャンネル特有のスタンプや絵文字は固定リストではカバーできないため、
		外部ファイル（テキスト）でユーザーが定義できるようにする。
	- 例: `custom_emoji.txt` に 1 行 1 トークンで定義。

### 5-2. スパチャの扱い

- スーパーチャット（スパチャ）は、
	- 金額の大小と「盛り上がり」の相関が必ずしも高くない
    - 配信の性質に応じて投げられる頻度が概ね決まっており、その瞬間の配信盛り上がりとの相関は薄い
	- 一人が黙々とスパチャを連投しても、チャット全体の沸きとは別物
 という事情があるため、**初期バージョンではスコア計算に含めない**方針とする。

将来的な拡張として、

- スパチャ発生直後のコメント密度の変化

などを指標にする余地はあるが、本設計ではスコープ外とする。

### 5-3. 時間方向の扱い（スライディングウィンドウ）

単純に「5 秒ごとのディスクリートな区切り」でスコアを計算すると、
実際には 10〜15 秒程度連続して盛り上がっている箇所が、
たまたま区切り位置の関係で**2 つのビンに分割されて弱く見える**問題がある。

これを避けるために、次のようなスライディングウィンドウ的な考え方を採用する。

1. **集計用の固定ビン**は 5 秒幅で維持する。
	 - コメント数や絵文字出現数そのものは、実装のしやすさから
		 5 秒ごとのバケットにまず集計する。
2. その後、時間方向に対して**移動平均（あるいはガウシアンフィルタ）**を適用し、
	 スコアを平滑化する。
	 - 例: 幅 3 ビン（= 15 秒相当）の移動平均
	 - これにより、単発のスパイクやビン境界の揺らぎを吸収し、
		 「実際に連続して沸いている区間」をなだらかなスコアの山として表現できる。
3. ピーク検出や SRT 区間生成は、この**平滑化後のスコア列**に対して行う。
	 - 閾値を超える連続区間を検出する際、
		 スライディングウィンドウ的に平均化された値を使うことで、
		 区間が 2 つに不自然に分割されるケースを減らす。

この設計により、内部的には「5 秒ビン + 平滑化」で実装しつつ、
実質的にはスライディングウィンドウに近い性質を持たせることを目指す。

---

## 6. CLI インターフェイス案

※詳細は後続で詰める。ここでは大まかな形だけ示す。

```bash

python -m hype_finder \
	-o clips/ina-colorful-stage/hype \
	--emoji-dict settings/hype-finder-emoji.txt \
	--live-chat-json clips/ina-colorful-stage/hype-data/VIDEO_ID.live_chat.json
```

主なオプション案:

- `--live-chat-json` : yt-dlp が出力したライブチャット字幕 JSON のパス
- `--live-chat-jsonl`: すでに前処理済みの JSONL ファイルパス（指定時は JSON → JSONL 変換をスキップ）
- `-o, --outdir`     : 出力ディレクトリ（SRT / PNG をここに出力）
- `--emoji-dict`     : カスタム絵文字・リアクション単語の定義ファイルパス
- `--window-sec`     : コメント集計ウィンドウサイズ（秒）
- `--top-k`          : 出力する盛り上がり区間の最大数（未指定時は動画長から自動計算）

### 6-1. `top-k` のデフォルト値（動画長依存）

`--top-k` を明示しない場合のデフォルト値は、
動画の総再生時間に応じて自動的に決まるようにする。

基本方針:

- 15 分程度の配信なら 2 箇所くらい
- 30 分で 3 箇所、その後は 30 分伸びるごとに 1 箇所追加

具体的なルール例:

- 動画長を分単位で `L` とする。
- デフォルトの `top-k` を次のように定義する:

	$$
	k_{\text{default}} = \max\bigl(2,\ 1 + \left\lfloor \frac{L}{30} \right\rfloor \bigr)
	$$

このときおおよそ次のような挙動になる:

- 0〜29 分: `k_default = 2`
- 30〜59 分: `k_default = 2` or `3`（実装時に微調整可）
- 60〜89 分: `k_default = 3` or `4`

実装時には、以下のような直感ベースのテーブルにしてもよい:

- 0〜20 分: 2 個
- 20〜40 分: 3 個
- 40〜70 分: 4 個
- 70 分〜: 5 個以上（30 分ごとに +1 など）

いずれにせよ、「長い配信ほど hype 候補区間を多めに返す」ことを
デフォルト仕様として明記しておき、実装段階で係数は調整可能とする。

---

## 7. cliptools 既存ワークフローとの関係（将来案）

現時点では hype-finder は `beta/` 内の独立ツールとして設計するが、
将来的には次のような連携を想定する。

- `download.sh` で取得したクリップと、hype-finder で得られた盛り上がり区間を組み合わせ、
	「コメント的に盛り上がっている区間」を優先的に切り出す補助ツールとして利用する。
- コメント由来の hype 区間と、発話内容ベースの SRT/翻訳結果を組み合わせて、
	「日本語字幕付きのおすすめクリップ候補」を自動列挙する。

ただし、本設計ドキュメントおよび初期実装フェーズでは、
**beta 外のファイルへの依存や変更は行わない**ことを前提とする。

